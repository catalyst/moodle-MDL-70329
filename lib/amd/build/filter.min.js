define ("core/filter",["exports","core/local/filter/filtertypes/courseid","core/local/filter/base","core/str","core/notification","core/pending","core/local/filter/selectors","core/templates","core/custom_interaction_events","jquery"],function(a,b,c,d,e,f,g,h,i,j){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=void 0;b=k(b);c=k(c);e=k(e);f=k(f);g=k(g);h=k(h);i=k(i);j=k(j);var x="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function k(a){return a&&a.__esModule?a:{default:a}}function l(a){return p(a)||o(a)||n(a)||m()}function m(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function n(a,b){if(!a)return;if("string"==typeof a)return q(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return q(a,b)}function o(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function p(a){if(Array.isArray(a))return q(a)}function q(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function r(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){r=function(a){return typeof a}}else{r=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return r(a)}function s(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function t(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){s(h,d,e,f,g,"next",a)}function g(a){s(h,d,e,f,g,"throw",a)}f(void 0)})}}function u(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function v(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function w(a,b,c){if(b)v(a.prototype,b);if(c)v(a,c);return a}var y=function(){function a(c,d){u(this,a);this.filterSet=c;this.applyCallback=d;this.activeFilters={courseid:new b.default("courseid",c)}}w(a,[{key:"init",value:function init(){var a=this;this.filterSet.querySelector(g.default.filterset.region).addEventListener("click",function(b){if(b.target.closest(g.default.filterset.actions.addRow)){b.preventDefault();a.addFilterRow()}if(b.target.closest(g.default.filterset.actions.applyFilters)){b.preventDefault();a.updateTableFromFilter()}if(b.target.closest(g.default.filterset.actions.resetFilters)){b.preventDefault();a.removeAllFilters();a.cleanUrlParams()}});this.filterSet.querySelector(g.default.filterset.regions.filterlist).addEventListener("click",function(b){if(b.target.closest(g.default.filter.actions.remove)){b.preventDefault();a.removeOrReplaceFilterRow(b.target.closest(g.default.filter.region),!0)}});var b=(0,j.default)(this.getFilterRegion());i.default.define(b,[i.default.events.accessibleChange]);b.on(i.default.events.accessibleChange,function(b){var c=b.target.closest(g.default.filter.fields.type);if(c&&c.value){var d=b.target.closest(g.default.filter.region);a.addFilter(d,c.value)}});this.filterSet.querySelector(g.default.filterset.fields.join).addEventListener("change",function(b){a.filterSet.dataset.filterverb=b.target.value})}},{key:"getFilterRegion",value:function getFilterRegion(){return this.filterSet.querySelector(g.default.filterset.regions.filterlist)}},{key:"addFilterRow",value:function addFilterRow(){var a=this,b=new f.default("core/filter:addFilterRow"),c=1+this.getFilterRegion().querySelectorAll(g.default.filter.region).length;return h.default.renderForPromise("core/filter_row",{rownumber:c}).then(function(b){var c=b.html,d=b.js,e=h.default.appendNodeContents(a.getFilterRegion(),c,d);return e}).then(function(b){var c=a.filterSet.querySelector(g.default.data.typeList);b.forEach(function(a){var b=a.querySelector(g.default.filter.fields.type);if(b){b.innerHTML=c.innerHTML}});return b}).then(function(b){a.updateFiltersOptions();return b}).then(function(a){b.resolve();return a}).catch(e.default.exception)}},{key:"getFilterDataSource",value:function getFilterDataSource(a){var b=this.filterSet.querySelector(g.default.filterset.regions.datasource);return b.querySelector(g.default.data.fields.byName(a))}},{key:"addFilter",value:function(){var a=t(regeneratorRuntime.mark(function a(b,d,e,f,h){var i,j,k,l;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:b.dataset.filterType=d;i=this.getFilterDataSource(d);j=c.default;if(!i.dataset.filterTypeClass){a.next=7;break}a.next=6;return"function"==typeof x.define&&x.define.amd?new Promise(function(a,b){x.require([i.dataset.filterTypeClass],a,b)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&x.require&&"component"===x.require.loader?Promise.resolve(require((i.dataset.filterTypeClass))):Promise.resolve(x[i.dataset.filterTypeClass]);case 6:j=a.sent;case 7:this.activeFilters[d]=new j(d,this.filterSet,e,h);k=b.querySelector(g.default.filter.fields.type);k.value=d;k.disabled="disabled";l=b.querySelector(g.default.filter.fields.join);if(!1===isNaN(f)){l.value=f;l.disabled="disabled"}this.updateFiltersOptions();return a.abrupt("return",this.activeFilters[d]);case 15:case"end":return a.stop();}}},a,this)}));return function addFilter(){return a.apply(this,arguments)}}()},{key:"getFilterObject",value:function getFilterObject(a){return this.activeFilters[a]}},{key:"removeOrReplaceFilterRow",value:function removeOrReplaceFilterRow(a,b){var c=this.getFilterRegion().querySelectorAll(g.default.filter.region).length;if(1===c){this.replaceFilterRow(a,b)}else{this.removeFilterRow(a,b)}}},{key:"removeFilterRow",value:function(){var a=t(regeneratorRuntime.mark(function a(b){var c,d,e,f,h=arguments;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c=1<h.length&&h[1]!==void 0?h[1]:!0;d=b.querySelector(g.default.filter.fields.type);e=!!d.value;this.removeFilterObject(b.dataset.filterType);b.remove();this.updateFiltersOptions();if(e&&c){this.updateTableFromFilter()}a.next=9;return this.getAvailableFilterLegends();case 9:f=a.sent;this.getFilterRegion().querySelectorAll(g.default.filter.region).forEach(function(a,b){a.querySelector("legend").innerText=f[b]});case 11:case"end":return a.stop();}}},a,this)}));return function removeFilterRow(){return a.apply(this,arguments)}}()},{key:"replaceFilterRow",value:function replaceFilterRow(a){var b=this,c=1<arguments.length&&arguments[1]!==void 0?arguments[1]:!0,d=2<arguments.length&&arguments[2]!==void 0?arguments[2]:1;this.removeFilterObject(a.dataset.filterType);return h.default.renderForPromise("core/filter_row",{rownumber:d}).then(function(b){var c=b.html,d=b.js,e=h.default.replaceNode(a,c,d);return e}).then(function(a){var c=b.filterSet.querySelector(g.default.data.typeList);a.forEach(function(a){var b=a.querySelector(g.default.filter.fields.type);if(b){b.innerHTML=c.innerHTML}});return a}).then(function(a){b.updateFiltersOptions();return a}).then(function(a){if(c){return b.updateTableFromFilter()}else{return a}}).catch(e.default.exception)}},{key:"removeFilterObject",value:function removeFilterObject(a){if(a){var b=this.getFilterObject(a);if(b){b.tearDown();delete this.activeFilters[a]}}}},{key:"removeAllFilters",value:function removeAllFilters(){var a=this,b=this.getFilterRegion().querySelectorAll(g.default.filter.region);b.forEach(function(b){return a.removeOrReplaceFilterRow(b,!1)});return this.updateTableFromFilter()}},{key:"removeEmptyFilters",value:function removeEmptyFilters(){var a=this,b=this.getFilterRegion().querySelectorAll(g.default.filter.region);b.forEach(function(b){var c=b.querySelector(g.default.filter.fields.type);if(!c.value){a.removeOrReplaceFilterRow(b,!1)}})}},{key:"updateFiltersOptions",value:function updateFiltersOptions(){var a=this,b=this.getFilterRegion().querySelectorAll(g.default.filter.region);b.forEach(function(b){var c=b.querySelectorAll(g.default.filter.fields.type+" option");c.forEach(function(c){if(c.value===b.dataset.filterType){c.classList.remove("hidden");c.disabled=!1}else if(a.activeFilters[c.value]){c.classList.add("hidden");c.disabled=!0}else{c.classList.remove("hidden");c.disabled=!1}})});var c=this.filterSet.querySelector(g.default.filterset.actions.addRow),d=this.filterSet.querySelectorAll(g.default.data.fields.all);if(d.length<=b.length){c.setAttribute("disabled","disabled")}else{c.removeAttribute("disabled")}if(1===b.length){this.filterSet.querySelector(g.default.filterset.regions.filtermatch).classList.add("hidden");this.filterSet.querySelector(g.default.filterset.fields.join).value=2;this.filterSet.dataset.filterverb=2}else{this.filterSet.querySelector(g.default.filterset.regions.filtermatch).classList.remove("hidden")}}},{key:"updateTableFromFilter",value:function updateTableFromFilter(){var a=new f.default("core/filter:updateTableFromFilter"),b={};Object.values(this.activeFilters).forEach(function(a){b[a.filterValue.name]=a.filterValue});this.updateUrlParams(b);if(this.applyCallback){this.applyCallback(b,a)}}},{key:"updateUrlParams",value:function updateUrlParams(a){var b=new URL(location.href),c=this.objectToQuery(a);b.searchParams.set("filter",c);history.pushState(a,"",b)}},{key:"cleanUrlParams",value:function cleanUrlParams(){var a=location.search,b=new URLSearchParams(a);if(b.has("cmid")){var c=new URL(location.href.replace(location.search,""));c.searchParams.set("cmid",b.get("cmid"));history.pushState({},"",c)}if(b.has("courseid")){var d=new URL(location.href.replace(location.search,""));d.searchParams.set("courseid",b.get("courseid"));history.pushState({},"",d)}}},{key:"objectToQuery",value:function objectToQuery(a){var b=this;return Object.keys(a).map(function(c){var d=a[c];if(null!==d&&"object"===r(d)){d=b.objectToQuery(d)}return"".concat(c,"=").concat(encodeURIComponent("".concat(d).replace(/\s/g,"_")))}).join("&")}},{key:"getAvailableFilterLegends",value:function(){var a=t(regeneratorRuntime.mark(function a(){var b,c,f;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:b=document.querySelector(g.default.data.typeListSelect).length-1;c=[];l(Array(b)).forEach(function(a,b){c.push({key:"filterrowlegend",component:"core_user",param:b+1})});a.next=5;return(0,d.get_strings)(c).then(function(a){return a}).catch(e.default.exception);case 5:f=a.sent;return a.abrupt("return",f);case 7:case"end":return a.stop();}}},a)}));return function getAvailableFilterLegends(){return a.apply(this,arguments)}}()}]);return a}();a.default=y;return a.default});
//# sourceMappingURL=filter.min.js.map
