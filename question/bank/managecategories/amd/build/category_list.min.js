define("qbank_managecategories/category_list",["exports","core/ajax","core/fragment","core/notification","core/templates","core/modal_factory","core/str"],(function(_exports,_ajax,_fragment,_notification,_templates,_modal_factory,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Javascript module handling ordering of categories.
   *
   * @module     qbank_managecategories
   * @copyright  2021 Catalyst IT Australia Pty Ltd
   * @author     Ghaly Marc-Alexandre <marc-alexandreghaly@catalyst-ca.net>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   *
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_fragment=_interopRequireDefault(_fragment),_notification=_interopRequireDefault(_notification),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory);const SELECTORS_CATEGORY_LIST=".category_list",SELECTORS_MODAL_CATEGORY_ITEM=".modal_category_item[data-categoryid]",SELECTORS_CATEGORY_RENDERED="#categoriesrendered",SELECTORS_SHOW_DESCRIPTION_CHECKBOX='[name="qbshowdescr"]',SELECTORS_MOVE_CATEGORY_MENU_ITEM='[role="menuitem"][data-actiontype="move"]',SELECTORS_DRAGGABLE_ITEM='[draggable="true"]',SELECTORS_DROPPABLE_ITEM=".list_item[data-categoryid]",getCategoriesFragment=contextid=>{let params={url:location.href};return _fragment.default.loadFragment("qbank_managecategories","category_rendering",contextid,params)},setCatOrder=(origincategory,insertaftercategory,pagecontextid)=>{const call={methodname:"qbank_managecategories_update_category_order",args:{origincategory:origincategory,insertaftercategory:insertaftercategory}};_ajax.default.call([call])[0].then((()=>getCategoriesFragment(pagecontextid))).catch((error=>{var _document$getElements;return _notification.default.addNotification({message:error.message,type:"error"}),null===(_document$getElements=document.getElementsByClassName("alert-danger")[0])||void 0===_document$getElements||_document$getElements.scrollIntoView(),getCategoriesFragment(pagecontextid)})).then(((html,js)=>{_templates.default.replaceNode("#categoriesrendered",html,js)})).catch(_notification.default.exception)};_exports.init=pagecontextid=>{(pagecontextid=>{document.addEventListener("click",(e=>{if(!e.target.closest(SELECTORS_CATEGORY_RENDERED))return;const actionIcon=e.target.closest(".action-icon");if(!actionIcon)return;const data=actionIcon.dataset,call={methodname:"qbank_managecategories_update_category_order",args:{origincategory:data.tomove,newparentcategory:data.tocategory}};_ajax.default.call([call])[0].then((()=>getCategoriesFragment(pagecontextid))).then(((html,js)=>{_templates.default.replaceNode(SELECTORS_CATEGORY_RENDERED,html,js)})).catch(_notification.default.exception)}))})(pagecontextid),(pagecontextid=>{const draggableitems=document.querySelectorAll(SELECTORS_DRAGGABLE_ITEM),droppableitems=document.querySelectorAll(SELECTORS_DROPPABLE_ITEM);let categoryid;const getTouchTarget=e=>document.elementFromPoint(e.changedTouches[0].pageX,e.changedTouches[0].pageY).closest(SELECTORS_DROPPABLE_ITEM),handleDragStart=e=>{var _target$dataset;const target=e.target.closest(SELECTORS_DRAGGABLE_ITEM);target&&(categoryid=null===(_target$dataset=target.dataset)||void 0===_target$dataset?void 0:_target$dataset.categoryid,"touchstart"==e.type&&e.cancelable&&e.preventDefault())},handleDrag=e=>{let target;droppableitems.forEach((item=>{item.classList.remove("border-danger")})),target="touchmove"==e.type?getTouchTarget(e):e.target.closest(SELECTORS_DROPPABLE_ITEM),target&&categoryid&&target.classList.add("border-danger")},handleDragEnd=e=>{let target;if(target="touchend"==e.type?getTouchTarget(e):e.target.closest(SELECTORS_DROPPABLE_ITEM),!target||!categoryid)return;const source=document.getElementById("category-".concat(categoryid));if(!source)return;e.preventDefault(),categoryid=null,target.closest(SELECTORS_CATEGORY_LIST).insertBefore(source,target.nextSibling);const originCategory=source.dataset.categoryid,insertaftercategory=target.dataset.categoryid;setCatOrder(originCategory,insertaftercategory,pagecontextid)},allowDrop=e=>{e.preventDefault()};draggableitems.forEach((item=>{item.setAttribute("style","touch-action: none;")})),droppableitems.forEach((item=>{item.addEventListener("dragenter",handleDrag),item.addEventListener("dragover",allowDrop),item.addEventListener("drop",handleDragEnd)})),draggableitems.forEach((item=>{item.addEventListener("touchstart",handleDragStart,!1),item.addEventListener("touchmove",handleDrag,!1),item.addEventListener("touchend",handleDragEnd,!1),item.addEventListener("dragstart",handleDragStart)}))})(pagecontextid),document.addEventListener("click",(e=>{const checkbox=e.target.closest(SELECTORS_SHOW_DESCRIPTION_CHECKBOX);checkbox&&checkbox.form.submit()})),(pagecontextid=>{document.addEventListener("click",(e=>{const item=e.target.closest(SELECTORS_MOVE_CATEGORY_MENU_ITEM);if(!item)return;if(item.getAttribute("aria-disabled"))return;item.setAttribute("aria-disabled",!0);const call={methodname:"qbank_managecategories_get_categories_in_a_context",args:{contextid:pagecontextid}};_ajax.default.call([call])[0].then((data=>(data.contexts.forEach((context=>{context.contextid==item.dataset.contextid&&context.categories.forEach((category=>{category.id!=item.dataset.categoryid||(category.disabled=!0)}))})),_templates.default.renderForPromise("qbank_managecategories/move_category",data)))).then((template=>_modal_factory.default.create({title:(0,_str.get_string)("movecategory","question"),body:template.html}))).then((modal=>{modal.show(),document.querySelector(".modal").addEventListener("click",(e=>{const target=e.target.closest(SELECTORS_MODAL_CATEGORY_ITEM);target&&(setCatOrder(item.dataset.categoryid,target.dataset.categoryid,pagecontextid),modal.destroy())})),item.setAttribute("aria-disabled",!1)})).catch(_notification.default.exception)}))})(pagecontextid)}}));

//# sourceMappingURL=category_list.min.js.map