{"version":3,"sources":["../src/addcategory_dialogue.js"],"names":["displayModal","selector","contextid","categoryid","title","Str","get_string","trigger","document","querySelector","ModalFactory","create","type","types","SAVE_CANCEL","body","getBody","large","done","modal","addEventListener","show","setSaveButtonText","root","getRoot","on","ModalEvents","hidden","setBody","shown","append","save","e","submitForm","submitFormAjax","then","hide","location","reload","catch","error","params","id","htmlBody","Fragment","loadFragment","preventDefault","changeEvent","createEvent","initEvent","find","each","index","element","dispatchEvent","invalid","length","first","focus","formData","serialize","methodname","Promise","resolve","Ajax","call","args","jsonformdata","JSON","stringify","fail","Notification","exception","submit","initModal"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript module handling creation of Modal form.\n *\n * @package    qbank_managecategories\n * @copyright  2021 Catalyst IT Australia Pty Ltd\n * @author     Ghaly Marc-Alexandre <marc-alexandreghaly@catalyst-ca.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n *\n */\n\nimport * as Str from 'core/str';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Fragment from 'core/fragment';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\n\n/**\n * Function handling display of moodle form.\n *\n * @param {string} selector Selector to trigger form display on.\n * @param {int} contextid Context id for fragment.\n */\nconst displayModal = (selector, contextid, categoryid) => {\n  let title = Str.get_string('addcategory', 'question');\n    if (categoryid !== undefined) {\n      title = Str.get_string('editcategory', 'question');\n    }\n    const trigger = document.querySelector(selector);\n    ModalFactory.create({\n      type: ModalFactory.types.SAVE_CANCEL,\n      title: title,\n      body: getBody(contextid, categoryid),\n      large: true,\n    })\n    .done((modal) => {\n      trigger.addEventListener('click', () => {\n        modal.show();\n      });\n      if (categoryid === undefined) {\n        modal.setSaveButtonText(Str.get_string('addcategory', 'question'));\n      }\n      const root = modal.getRoot();\n      root.on(ModalEvents.hidden, () => {\n        modal.setBody(getBody(contextid, categoryid));\n      });\n      root.on(ModalEvents.shown, () => {\n        root.append('<style>[data-fieldtype=submit] { display: none ! important; }</style>');\n      });\n      root.on(ModalEvents.save, (e) =>{\n        submitForm(modal, e);\n      });\n      root.on('submit', 'form', (e) => {\n        submitFormAjax(modal, categoryid, e)\n        .then(() => {\n          modal.hide();\n          location.reload();\n        })\n        .catch((error) => error);\n      });\n    });\n};\n\n/**\n * Get body for moodle form from fragment new_category_form.\n *\n * @param {int} contextid Context id for fragment.\n * @returns {Promise}\n */\nconst getBody = (contextid, categoryid) => {\n    let params = {};\n    if (categoryid !== undefined) {\n      params = {id: categoryid};\n    }\n    const htmlBody = Fragment.loadFragment('qbank_managecategories', 'new_category_form', contextid, params);\n    return htmlBody;\n};\n\n/**\n * Call external function add_category_form - inserts the newly added category in the question_categories table.\n *\n * @param {Object} modal Object representing form data.\n * @returns {Mixed}\n */\nconst submitFormAjax = (modal, categoryid, e) => {\n  e.preventDefault();\n  const changeEvent = document.createEvent('HTMLEvents');\n  changeEvent.initEvent('change', true, true);\n\n  modal.getRoot().find(':input').each((index, element) => {\n    element.dispatchEvent(changeEvent);\n  });\n\n  const invalid = modal.getRoot().find('[aria-invalid=\"true\"]');\n  const error = modal.getRoot().find('.error');\n\n  // If we found invalid fields, focus on the first one and do not submit via ajax.\n  if (invalid.length || error.length) {\n      invalid.first().focus();\n      return;\n  }\n\n  const formData =  modal.getRoot().find('form').serialize();\n  let methodname = 'qbank_managecategories_submit_edit_category_form';\n  if (categoryid === undefined) {\n    methodname = 'qbank_managecategories_submit_add_category_form';\n  }\n  return Promise.resolve(\n    Ajax.call([{\n    methodname: methodname,\n    args: {jsonformdata: JSON.stringify(formData)},\n    fail: Notification.exception\n  }]));\n};\n\n/**\n * This triggers a form submission, so that any mform elements can do final tricks before the form submission is processed.\n *\n * @param {Object} modal representing form data.\n * @param {Event} e Form submission event.\n */\nconst submitForm = (modal, e) => {\n  e.preventDefault();\n  modal.getRoot().find('form').submit();\n};\n\nexport const initModal = (selector, contextid, categoryid) => {\n  displayModal(selector, contextid, categoryid);\n};\n"],"file":"addcategory_dialogue.min.js"}