define("core_question/filter",["exports","core/ajax","core/filter","core/notification","core/local/filter/selectors","core/templates"],(function(_exports,_ajax,_filter,_notification,_selectors,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Question bank filter managemnet.
   *
   * @module     core_question/filter
   * @copyright  2021 Tomo Tsuyuki <tomotsuyuki@catalyst-au.net>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_filter=_interopRequireDefault(_filter),_notification=_interopRequireDefault(_notification),_selectors=_interopRequireDefault(_selectors),_templates=_interopRequireDefault(_templates);_exports.init=(filterRegionId,defaultcourseid,defaultcategoryid,perpage,recurse,showhidden,qbshowtext,contextId,component,callback,extraparams)=>{const filterSet=document.querySelector("#".concat(filterRegionId));let wsfilter={filters:[],filteroptions:{filterverb:2,recurse:recurse,showhidden:showhidden},displayoptions:{perpage:perpage,showtext:qbshowtext},sortdata:[{sortby:"qbank_viewquestiontype\\question_type_column",sortorder:4}],defaultcourseid:defaultcourseid,defaultcategoryid:defaultcategoryid};const SELECTORS_QUESTION_CONTAINER_ID="#questionscontainer",SELECTORS_SORT_LINK="#questionscontainer div.sorters a",SELECTORS_PAGINATION_LINK="#questionscontainer a[href].page-link",coreFilter=new _filter.default(filterSet,(function(filters,pendingPromise){applyFilter(filters,pendingPromise)}));coreFilter.init();const applyFilter=(filterdata,pendingPromise)=>{if(filterdata){wsfilter.filteroptions.filterverb=parseInt(filterSet.dataset.filterverb,10),wsfilter.filters=[];for(const[key,value]of Object.entries(filterdata)){let filter={filtertype:key,jointype:value.jointype,rangetype:value.rangetype,values:value.values.toString()};wsfilter.filters.push(filter)}0!==Object.keys(filterdata).length&&updateUrlParams(filterdata)}(filter=>{const request={methodname:"core_question_filter",args:filter};return _ajax.default.call([request])[0]})(wsfilter).then((response=>{let element=document.getElementById("user-notifications");for(;element.firstChild;)element.removeChild(element.firstChild);return void 0!==response.warnings[0]&&"nocategoryconditionspecified"===response.warnings[0].warningcode&&_notification.default.addNotification({message:response.warnings[0].message,type:"info"}),renderQuestiondata(response.filtercondition)})).then((response=>{const questionscontainer=document.querySelector(SELECTORS_QUESTION_CONTAINER_ID);void 0===response.questionhtml&&(response.questionhtml=""),void 0===response.jsfooter&&(response.jsfooter=""),_templates.default.replaceNodeContents(questionscontainer,response.questionhtml,response.jsfooter),pendingPromise&&pendingPromise.resolve()})).fail(_notification.default.exception)},renderQuestiondata=filtercondition=>{console.log(extraparams);const request={methodname:"core_question_view",args:{component:component,callback:callback,filtercondition:filtercondition,contextid:contextId,extraparams:extraparams}};return _ajax.default.call([request])[0]},updateUrlParams=filters=>{const url=new URL(location.href),query=objectToQuery(filters);url.searchParams.set("filter",query),history.pushState(filters,"",url)},objectToQuery=filters=>Object.keys(filters).map((key=>{let value=filters[key];return null!==value&&"object"==typeof value&&(value=objectToQuery(value)),"".concat(key,"=").concat(encodeURIComponent("".concat(value).replace(/\s/g,"_")))})).join("&"),queryToObject=query=>{const object={},params=new URLSearchParams(query);return params.entries().forEach((value=>{const param=value[0];object[param]=isNaN(params.get(param))?params.get(param):parseInt(params.get(param)),isNaN(object[param])&&object[param].includes("&")&&(object[param]=queryToObject(object[param])),"values"==param&&("string"==typeof object[param]&&object[param].includes("=")?object[param]=[object[param].split("=")[1]]:object[param]=Object.values(object[param]))})),object};document.addEventListener("click",(e=>{const sortableLink=e.target.closest(SELECTORS_SORT_LINK),paginationLink=e.target.closest(SELECTORS_PAGINATION_LINK),clearLink=e.target.closest(_selectors.default.filterset.actions.resetFilters);if(sortableLink){e.preventDefault();let oldsort=wsfilter.sortdata;wsfilter.sortdata=[];let sortdata={sortby:sortableLink.dataset.sortby,sortorder:sortableLink.dataset.sortorder};wsfilter.sortdata.push(sortdata),oldsort.forEach((value=>{value.sortby!==sortableLink.dataset.sortby&&wsfilter.sortdata.push(value)})),wsfilter.displayoptions.page=0,coreFilter.updateTableFromFilter()}if(paginationLink){e.preventDefault();let attr=e.target.getAttribute("href");if("#"!==attr){const urlParams=new URLSearchParams(attr);wsfilter.displayoptions.page=urlParams.get("qpage"),coreFilter.updateTableFromFilter()}}clearLink&&(()=>{const queryString=location.search,urlParams=new URLSearchParams(queryString);if(urlParams.has("cmid")){const cleanedUrl=new URL(location.href.replace(location.search,""));cleanedUrl.searchParams.set("cmid",urlParams.get("cmid")),history.pushState({},"",cleanedUrl)}if(urlParams.has("courseid")){const cleanedUrl=new URL(location.href.replace(location.search,""));cleanedUrl.searchParams.set("courseid",urlParams.get("courseid")),history.pushState({},"",cleanedUrl)}})()}));const urlLoadedFilters=(()=>{const queryString=location.search,urlParams=new URLSearchParams(queryString);if(urlParams.has("filter")){return queryToObject(urlParams.get("filter"))}return{}})(),filter=filterSet.querySelector(_selectors.default.filter.region);if(0!==Object.entries(urlLoadedFilters).length)for(const urlFilter in urlLoadedFilters)"courseid"!==urlFilter&&coreFilter.addFilter(filter,urlFilter,urlLoadedFilters[urlFilter].values,urlLoadedFilters[urlFilter].jointype,urlLoadedFilters[urlFilter].rangetype);else coreFilter.addFilter(filter,"category",[defaultcategoryid]);applyFilter(urlLoadedFilters)}}));

//# sourceMappingURL=filter.min.js.map