{"version":3,"file":"filter.min.js","sources":["../src/filter.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Question bank filter managemnet.\n *\n * @module     core_question/filter\n * @copyright  2021 Tomo Tsuyuki <tomotsuyuki@catalyst-au.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ajax from 'core/ajax';\nimport CoreFilter from 'core/filter';\nimport Notification from 'core/notification';\nimport Selectors from 'core/local/filter/selectors';\nimport Templates from 'core/templates';\n\n/**\n * Initialise the question bank filter on the element with the given id.\n *\n * @param {String} filterRegionId id of the filter region\n * @param {String} defaultcourseid default course id\n * @param {String} defaultcategoryid default category id\n * @param {int} perpage number of question per page\n * @param {boolean} recurse if loading sub categories\n * @param {boolean} showhidden if loading hidden question\n * @param {boolean} qbshowtext if loading question text\n * @param {int} contextId id of the context\n * @param {string} component name of the component for fragment\n * @param {string} callback name of the callback for the fragment\n * @param {string} extraparams json encoded extra params for the extended apis\n */\nexport const init = (filterRegionId, defaultcourseid, defaultcategoryid,\n                     perpage, recurse, showhidden, qbshowtext,\n                     contextId, component, callback, extraparams) => {\n\n    const filterSet = document.querySelector(`#${filterRegionId}`);\n\n    // Default filter params for WS function.\n    let wsfilter = {\n        // Default value filterset::JOINTYPE_DEFAULT.\n        filters: [],\n        filteroptions: {\n            filterverb: 2,\n            recurse: recurse,\n            showhidden: showhidden,\n        },\n        displayoptions: {\n            perpage: perpage,\n            showtext: qbshowtext,\n        },\n        sortdata: [\n            {\n                sortby: 'qbank_viewquestiontype\\\\question_type_column',\n                sortorder: 4,\n            }\n        ],\n        defaultcourseid: defaultcourseid,\n        defaultcategoryid: defaultcategoryid,\n    };\n\n    // HTML <div> ID of question container.\n    const SELECTORS = {\n        QUESTION_CONTAINER_ID: '#questionscontainer',\n        SORT_LINK: '#questionscontainer div.sorters a',\n        PAGINATION_LINK: '#questionscontainer a[href].page-link',\n    };\n\n    // Init function with apply callback.\n    const coreFilter = new CoreFilter(filterSet, function(filters, pendingPromise) {\n        applyFilter(filters, pendingPromise);\n    });\n    coreFilter.init();\n\n    /**\n     * Ajax call to retrieve question via ws functions\n     *\n     * @param {Object} filter filter object\n     * @returns {*}\n     */\n    const requestQuestions = filter => {\n        const request = {methodname: 'core_question_filter', args: filter};\n        return ajax.call([request])[0];\n    };\n\n    /**\n     * Retrieve table data.\n     *\n     * @param {Object} filterdata data\n     * @param {Promise} pendingPromise pending promise\n     */\n    const applyFilter = (filterdata, pendingPromise) => {\n        // Getting filter data.\n        // Otherwise, the ws function should retrieves question based on default courseid and cateogryid.\n        if (filterdata) {\n            // Main join types.\n            wsfilter.filteroptions.filterverb = parseInt(filterSet.dataset.filterverb, 10);\n\n            // Clean old filter\n            wsfilter.filters = [];\n\n            // Retrieve fitter info.\n            for (const [key, value] of Object.entries(filterdata)) {\n                let filter = {\n                    'filtertype': key,\n                    'jointype': value.jointype,\n                    'rangetype': value.rangetype,\n                    'values': value.values.toString()\n                };\n                wsfilter.filters.push(filter);\n            }\n            if (Object.keys(filterdata).length !== 0) {\n                updateUrlParams(filterdata);\n            }\n        }\n        // Load questions for first page.\n        requestQuestions(wsfilter)\n            .then((response) => {\n                // Cleans any notifications if not needed.\n                let element = document.getElementById('user-notifications');\n                while (element.firstChild) {\n                    element.removeChild(element.firstChild);\n                }\n                if (response.warnings[0] !== undefined) {\n                    if (response.warnings[0].warningcode === 'nocategoryconditionspecified') {\n                        Notification.addNotification({\n                            message: response.warnings[0].message,\n                            type: 'info'\n                          });\n                    }\n                }\n                return renderQuestiondata(response.filtercondition);\n            })\n            // Render questions for first page and pagination.\n            .then((response) => {\n                const questionscontainer = document.querySelector(SELECTORS.QUESTION_CONTAINER_ID);\n                if (response.questionhtml === undefined) {\n                    response.questionhtml = '';\n                }\n                if (response.jsfooter === undefined) {\n                    response.jsfooter = '';\n                }\n                Templates.replaceNodeContents(questionscontainer, response.questionhtml, response.jsfooter);\n                // Resolve filter promise.\n                if (pendingPromise) {\n                    pendingPromise.resolve();\n                }\n            })\n            .fail(Notification.exception);\n    };\n\n    /**\n     * Render question data using the fragment.\n     * @param {object} filtercondition\n     * @return {*}\n     */\n    const renderQuestiondata = (filtercondition) => {\n        // eslint-disable-next-line no-console\n        console.log(extraparams);\n        const viewData = {\n            component: component,\n            callback: callback,\n            filtercondition: filtercondition,\n            contextid: contextId,\n            extraparams: extraparams,\n        };\n        const request = {methodname: 'core_question_view', args: viewData};\n        return ajax.call([request])[0];\n    };\n\n    /**\n     * Update URL Param based upon the current filter.\n     *\n     * @param {Object} filters Active filters.\n     */\n    const updateUrlParams = (filters) => {\n        const url = new URL(location.href);\n        const query = objectToQuery(filters);\n        url.searchParams.set('filter', query);\n        history.pushState(filters, '', url);\n    };\n\n    /**\n     * Cleans URL parameters.\n     *\n     */\n    const cleanUrlParams = () => {\n        const queryString = location.search;\n        const urlParams = new URLSearchParams(queryString);\n        if (urlParams.has('cmid')) {\n            const cleanedUrl = new URL(location.href.replace(location.search, ''));\n            cleanedUrl.searchParams.set('cmid', urlParams.get('cmid'));\n            history.pushState({}, '', cleanedUrl);\n        }\n\n        if (urlParams.has('courseid')) {\n            const cleanedUrl = new URL(location.href.replace(location.search, ''));\n            cleanedUrl.searchParams.set('courseid', urlParams.get('courseid'));\n            history.pushState({}, '', cleanedUrl);\n        }\n    };\n\n    /**\n     * Convert a nested object into query parameters.\n     *\n     * @param {Object} filters Active filters.\n     * @return {String}\n     */\n    const objectToQuery = (filters) => {\n        return Object.keys(filters).map(key => {\n            let value = filters[key];\n            if (value !== null && typeof value === 'object') {\n                value = objectToQuery(value);\n            }\n            return `${key}=${encodeURIComponent(`${value}`.replace(/\\s/g, '_'))}`;\n        }).join('&');\n    };\n\n    /**\n     * Load URL parameter.\n     *\n     * @return {Object} filters\n     */\n    const loadUrlParams = () => {\n        const queryString = location.search;\n        const urlParams = new URLSearchParams(queryString);\n        if (urlParams.has('filter')) {\n            const filters = queryToObject(urlParams.get('filter'));\n            return filters;\n        }\n        return {};\n    };\n\n    /**\n     * Convert query parameters into object.\n     *\n     * @param {string} query Query representing filter object.\n     * @return {object}\n     */\n    const queryToObject = (query) => {\n        const object = {};\n        const params = new URLSearchParams(query);\n        const entries = params.entries();\n        entries.forEach((value) => {\n            const param = value[0];\n            object[param] = !isNaN(params.get(param)) ? parseInt(params.get(param)) : params.get(param);\n            if (isNaN(object[param]) && object[param].includes('&')) {\n                object[param] = queryToObject(object[param]);\n            }\n            if (param == 'values') {\n                if (typeof object[param] == 'string' && object[param].includes('=')) {\n                    object[param] = [object[param].split('=')[1]];\n                } else {\n                    object[param] = Object.values(object[param]);\n                }\n            }\n        });\n        return object;\n    };\n\n    // Add listeners for the sorting actions.\n    document.addEventListener('click', e => {\n        const sortableLink = e.target.closest(SELECTORS.SORT_LINK);\n        const paginationLink = e.target.closest(SELECTORS.PAGINATION_LINK);\n        const clearLink = e.target.closest(Selectors.filterset.actions.resetFilters);\n        if (sortableLink) {\n            e.preventDefault();\n            let oldsort = wsfilter.sortdata;\n            wsfilter.sortdata = [];\n            let sortdata = {\n                sortby: sortableLink.dataset.sortby,\n                sortorder: sortableLink.dataset.sortorder\n            };\n            wsfilter.sortdata.push(sortdata);\n            oldsort.forEach(value => {\n                if (value.sortby !== sortableLink.dataset.sortby) {\n                    wsfilter.sortdata.push(value);\n                }\n            });\n            wsfilter.displayoptions.page = 0;\n            coreFilter.updateTableFromFilter();\n        }\n        if (paginationLink) {\n            e.preventDefault();\n            let attr = e.target.getAttribute(\"href\");\n            if (attr !== '#') {\n                const urlParams = new URLSearchParams(attr);\n                wsfilter.displayoptions.page = urlParams.get('qpage');\n                coreFilter.updateTableFromFilter();\n            }\n        }\n        if (clearLink) {\n            cleanUrlParams();\n        }\n    });\n\n    // Run apply filter at page load.\n    const urlLoadedFilters = loadUrlParams();\n    const filter = filterSet.querySelector(Selectors.filter.region);\n    if (Object.entries(urlLoadedFilters).length !== 0) {\n        for (const urlFilter in urlLoadedFilters) {\n            if (urlFilter !== 'courseid') {\n                coreFilter.addFilter(filter,\n                                     urlFilter,\n                                     urlLoadedFilters[urlFilter].values,\n                                     urlLoadedFilters[urlFilter].jointype,\n                                     urlLoadedFilters[urlFilter].rangetype);\n            }\n        }\n    } else {\n        coreFilter.addFilter(filter, 'category', [defaultcategoryid]);\n    }\n    applyFilter(urlLoadedFilters);\n};\n"],"names":["filterRegionId","defaultcourseid","defaultcategoryid","perpage","recurse","showhidden","qbshowtext","contextId","component","callback","extraparams","filterSet","document","querySelector","wsfilter","filters","filteroptions","filterverb","displayoptions","showtext","sortdata","sortby","sortorder","SELECTORS","coreFilter","CoreFilter","pendingPromise","applyFilter","init","filterdata","parseInt","dataset","key","value","Object","entries","filter","jointype","rangetype","values","toString","push","keys","length","updateUrlParams","request","methodname","args","ajax","call","requestQuestions","then","response","element","getElementById","firstChild","removeChild","undefined","warnings","warningcode","addNotification","message","type","renderQuestiondata","filtercondition","questionscontainer","questionhtml","jsfooter","replaceNodeContents","resolve","fail","Notification","exception","console","log","contextid","url","URL","location","href","query","objectToQuery","searchParams","set","history","pushState","map","encodeURIComponent","replace","join","queryToObject","object","params","URLSearchParams","forEach","param","isNaN","get","includes","split","addEventListener","e","sortableLink","target","closest","paginationLink","clearLink","Selectors","filterset","actions","resetFilters","preventDefault","oldsort","page","updateTableFromFilter","attr","getAttribute","urlParams","queryString","search","has","cleanedUrl","cleanUrlParams","urlLoadedFilters","loadUrlParams","region","urlFilter","addFilter"],"mappings":";;;;;;;4TA4CoB,CAACA,eAAgBC,gBAAiBC,kBACjCC,QAASC,QAASC,WAAYC,WAC9BC,UAAWC,UAAWC,SAAUC,qBAE3CC,UAAYC,SAASC,yBAAkBb,qBAGzCc,SAAW,CAEXC,QAAS,GACTC,cAAe,CACXC,WAAY,EACZb,QAASA,QACTC,WAAYA,YAEhBa,eAAgB,CACZf,QAASA,QACTgB,SAAUb,YAEdc,SAAU,CACN,CACIC,OAAQ,+CACRC,UAAW,IAGnBrB,gBAAiBA,gBACjBC,kBAAmBA,yBAIjBqB,gCACqB,sBADrBA,oBAES,oCAFTA,0BAGe,wCAIfC,WAAa,IAAIC,gBAAWd,WAAW,SAASI,QAASW,gBAC3DC,YAAYZ,QAASW,mBAEzBF,WAAWI,aAmBLD,YAAc,CAACE,WAAYH,qBAGzBG,WAAY,CAEZf,SAASE,cAAcC,WAAaa,SAASnB,UAAUoB,QAAQd,WAAY,IAG3EH,SAASC,QAAU,OAGd,MAAOiB,IAAKC,SAAUC,OAAOC,QAAQN,YAAa,KAC/CO,OAAS,YACKJ,aACFC,MAAMI,mBACLJ,MAAMK,iBACTL,MAAMM,OAAOC,YAE3B1B,SAASC,QAAQ0B,KAAKL,QAEa,IAAnCF,OAAOQ,KAAKb,YAAYc,QACxBC,gBAAgBf,YAhCHO,CAAAA,eACfS,QAAU,CAACC,WAAY,uBAAwBC,KAAMX,eACpDY,cAAKC,KAAK,CAACJ,UAAU,IAkC5BK,CAAiBpC,UACZqC,MAAMC,eAECC,QAAUzC,SAAS0C,eAAe,2BAC/BD,QAAQE,YACXF,QAAQG,YAAYH,QAAQE,wBAEHE,IAAzBL,SAASM,SAAS,IACuB,iCAArCN,SAASM,SAAS,GAAGC,mCACRC,gBAAgB,CACzBC,QAAST,SAASM,SAAS,GAAGG,QAC9BC,KAAM,SAIXC,mBAAmBX,SAASY,oBAGtCb,MAAMC,iBACGa,mBAAqBrD,SAASC,cAAcU,sCACpBkC,IAA1BL,SAASc,eACTd,SAASc,aAAe,SAEFT,IAAtBL,SAASe,WACTf,SAASe,SAAW,uBAEdC,oBAAoBH,mBAAoBb,SAASc,aAAcd,SAASe,UAE9EzC,gBACAA,eAAe2C,aAGtBC,KAAKC,sBAAaC,YAQrBT,mBAAsBC,kBAExBS,QAAQC,IAAIhE,mBAQNmC,QAAU,CAACC,WAAY,qBAAsBC,KAPlC,CACbvC,UAAWA,UACXC,SAAUA,SACVuD,gBAAiBA,gBACjBW,UAAWpE,UACXG,YAAaA,qBAGVsC,cAAKC,KAAK,CAACJ,UAAU,IAQ1BD,gBAAmB7B,gBACf6D,IAAM,IAAIC,IAAIC,SAASC,MACvBC,MAAQC,cAAclE,SAC5B6D,IAAIM,aAAaC,IAAI,SAAUH,OAC/BI,QAAQC,UAAUtE,QAAS,GAAI6D,MA6B7BK,cAAiBlE,SACZmB,OAAOQ,KAAK3B,SAASuE,KAAItD,UACxBC,MAAQlB,QAAQiB,YACN,OAAVC,OAAmC,iBAAVA,QACzBA,MAAQgD,cAAchD,kBAEhBD,gBAAOuD,mBAAmB,UAAGtD,OAAQuD,QAAQ,MAAO,UAC/DC,KAAK,KAwBNC,cAAiBV,cACbW,OAAS,GACTC,OAAS,IAAIC,gBAAgBb,cACnBY,OAAOzD,UACf2D,SAAS7D,cACP8D,MAAQ9D,MAAM,GACpB0D,OAAOI,OAAUC,MAAMJ,OAAOK,IAAIF,QAAwCH,OAAOK,IAAIF,OAAzCjE,SAAS8D,OAAOK,IAAIF,QAC5DC,MAAML,OAAOI,SAAWJ,OAAOI,OAAOG,SAAS,OAC/CP,OAAOI,OAASL,cAAcC,OAAOI,SAE5B,UAATA,QAC4B,iBAAjBJ,OAAOI,QAAsBJ,OAAOI,OAAOG,SAAS,KAC3DP,OAAOI,OAAS,CAACJ,OAAOI,OAAOI,MAAM,KAAK,IAE1CR,OAAOI,OAAS7D,OAAOK,OAAOoD,OAAOI,YAI1CJ,QAIX/E,SAASwF,iBAAiB,SAASC,UACzBC,aAAeD,EAAEE,OAAOC,QAAQjF,qBAChCkF,eAAiBJ,EAAEE,OAAOC,QAAQjF,2BAClCmF,UAAYL,EAAEE,OAAOC,QAAQG,mBAAUC,UAAUC,QAAQC,iBAC3DR,aAAc,CACdD,EAAEU,qBACEC,QAAUlG,SAASM,SACvBN,SAASM,SAAW,OAChBA,SAAW,CACXC,OAAQiF,aAAavE,QAAQV,OAC7BC,UAAWgF,aAAavE,QAAQT,WAEpCR,SAASM,SAASqB,KAAKrB,UACvB4F,QAAQlB,SAAQ7D,QACRA,MAAMZ,SAAWiF,aAAavE,QAAQV,QACtCP,SAASM,SAASqB,KAAKR,UAG/BnB,SAASI,eAAe+F,KAAO,EAC/BzF,WAAW0F,2BAEXT,eAAgB,CAChBJ,EAAEU,qBACEI,KAAOd,EAAEE,OAAOa,aAAa,WACpB,MAATD,KAAc,OACRE,UAAY,IAAIxB,gBAAgBsB,MACtCrG,SAASI,eAAe+F,KAAOI,UAAUpB,IAAI,SAC7CzE,WAAW0F,yBAGfR,WAzGe,YACbY,YAAcxC,SAASyC,OACvBF,UAAY,IAAIxB,gBAAgByB,gBAClCD,UAAUG,IAAI,QAAS,OACjBC,WAAa,IAAI5C,IAAIC,SAASC,KAAKS,QAAQV,SAASyC,OAAQ,KAClEE,WAAWvC,aAAaC,IAAI,OAAQkC,UAAUpB,IAAI,SAClDb,QAAQC,UAAU,GAAI,GAAIoC,eAG1BJ,UAAUG,IAAI,YAAa,OACrBC,WAAa,IAAI5C,IAAIC,SAASC,KAAKS,QAAQV,SAASyC,OAAQ,KAClEE,WAAWvC,aAAaC,IAAI,WAAYkC,UAAUpB,IAAI,aACtDb,QAAQC,UAAU,GAAI,GAAIoC,cA8F1BC,YAKFC,iBA1EgB,YACZL,YAAcxC,SAASyC,OACvBF,UAAY,IAAIxB,gBAAgByB,gBAClCD,UAAUG,IAAI,UAAW,QACT9B,cAAc2B,UAAUpB,IAAI,iBAGzC,IAmEc2B,GACnBxF,OAASzB,UAAUE,cAAc8F,mBAAUvE,OAAOyF,WACR,IAA5C3F,OAAOC,QAAQwF,kBAAkBhF,WAC5B,MAAMmF,aAAaH,iBACF,aAAdG,WACAtG,WAAWuG,UAAU3F,OACA0F,UACAH,iBAAiBG,WAAWvF,OAC5BoF,iBAAiBG,WAAWzF,SAC5BsF,iBAAiBG,WAAWxF,gBAIzDd,WAAWuG,UAAU3F,OAAQ,WAAY,CAAClC,oBAE9CyB,YAAYgG"}